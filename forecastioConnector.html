<!DOCTYPE html>
<html lang="en">
<meta http-equiv="Cache-Control" content="no-store" />

<head>
  <meta charset="utf-8" />
  <script type="text/javascript" src="js/jquery-2.1.4.js"></script>
  <script type="text/javascript" src="js/moment.min.js"></script>
  <script type="text/javascript" src="https://connectors.tableau.com/libs/tableauwdc-1.1.1.js"></script>
  <script type="text/javascript">
    // Use anon self-executing function
  (function() {
    

    // Use Moment to convert dates to acceptible format for Tableau
    function DateToTableauDate(dateToConvert) {
      // Use moment
      var tableauDate = moment.unix(dateToConvert).format("YYYY-MM-DD HH:mm:ss.SSS");   // Forecast.io timestaps are unix
      
      return tableauDate;
    }
    
    // ------------------------------------------------------------
    // Define our connector
    // ------------------------------------------------------------
    var myConnector = tableau.makeConnector();
    
    
    // ------------------------------------------------------------
    // Set-up column headers so Tableau knows about our fields
    // and their datatypes (26 fields)
    // ------------------------------------------------------------
    myConnector.getColumnHeaders = function() {
      var fieldNames = ['time', 'summary', 'sunriseTime', 'sunsetTime', 'moonPhase', 'precipIntensity', 'precipIntensityMax', 'precipIntensityMaxTime', 'precipProbability', 'precipType', 'temperatureMin', 'temperatureMinTime', 'temperatureMax', 'temperatureMaxTime', 'apparentTemperatureMin', 'apparentTemperatureMinTime', 'apparentTemperatureMax', 'apparentTemperatureMaxTime', 'dewPoint', 'humidity', 'windSpeed', 'windBearing', 'visibility', 'cloudCover', 'pressure', 'ozone'];
      var fieldTypes = ['datetime', 'string', 'datetime', 'datetime', 'float', 'float', 'float', 'int', 'float', 'string', 'float', 'datetime', 'float', 'datetime', 'float', 'datetime', 'float', 'datetime', 'float', 'float', 'float', 'int', 'float', 'float', 'float', 'int'];
      
      tableau.headersCallback(fieldNames, fieldTypes);
    };
    
    // ------------------------------------------------------------
    // Money function to get data
    // ------------------------------------------------------------
    myConnector.getTableData = function(lastRecordToken) {
      
      // forecast.io not set-up for CORS so using JSONP to get the data
      $.getJSON(tableau.connectionData + "?callback=?", function(data) {
        // We've got data so format & send to Tableau
        if(data) {
          var i;
          var toRet = [];
          var daily = data.daily.data;
          
          for(i = 0; i < daily.length; i++) {
            var row = {
              "time": DateToTableauDate(daily[i].time),
              "summary": daily[i].summary,
              "sunriseTime": DateToTableauDate(daily[i].sunriseTime),
              "sunsetTime": DateToTableauDate(daily[i].sunsetTime),
              "moonPhase": daily[i].moonPhase,
              "precipIntensity": daily[i].precipIntensity,
              "precipIntensityMax": daily[i].precipIntensityMax,
              "precipIntensityMaxTime": daily[i].precipIntensityMaxTime,
              "precipProbability": daily[i].precipProbability,
              "precipType": daily[i].precipType,
              "temperatureMin": daily[i].temperatureMin,
              "temperatureMinTime": DateToTableauDate(daily[i].temperatureMinTime),
              "temperatureMax": daily[i].temperatureMax,
              "temperatureMaxTime": DateToTableauDate(daily[i].temperatureMaxTime),
              "apparentTemperatureMin": daily[i].apparentTemperatureMin,
              "apparentTemperatureMinTime": DateToTableauDate(daily[i].apparentTemperatureMinTime),
              "apparentTemperatureMax": daily[i].apparentTemperatureMax,
              "apparentTemperatureMaxTime": DateToTableauDate(daily[i].apparentTemperatureMaxTime),
              "dewPoint": daily[i].dewPoint,
              "humidity": daily[i].humidity,
              "windSpeed": daily[i].windSpeed,
              "windBearing": daily[i].windBearing,
              "visibility": daily[i].visibility,
              "cloudCover": daily[i].cloudCover,
              "pressure": daily[i].pressure,
              "ozone": daily[i].ozone
              
            };
            
            toRet.push(row);
          }
          
          // Call back to tableau with the table data and the new record number (this is stored as a string)
          tableau.dataCallback(toRet, toRet.length.toString(), false);
          
        } else {
          tableau.log("error getting data");
          tableau.abortWithError("error getting data from forecast.io");
        }
      });
    };
    
    // ------------------------------------------------------------
    // Set-up our URL
    // ------------------------------------------------------------
    myConnector.setLocation = function(latitude, longitude) {
      // Hard-code our Forecast.io API Key
      var apiKey = 'a328cf110f5d0b477e730b71c2cde8de';
      
      // Construct our URL for the API call
      var url = 'https://api.forecast.io/forecast/' + apiKey + '/' + latitude + ',' + longitude;
      
      tableau.connectionData = url;
      tableau.connectionName = 'Forecast.io Weather Data for ' + latitude + ' ' + longitude;
    }
    
    // ------------------------------------------------------------
    // Register the connector
    // ------------------------------------------------------------
    tableau.registerConnector(myConnector);
    
    
    // UI -> use jQuery for button click handler
    $(document).ready(function(){
      $("#submitButton").click(function() {
      
        // Get our lat/long values that were provided
        var latitude = $('#latitude').val();
        var longitude = $('#longitude').val();
        latitude = latitude.trim();
        longitude = longitude.trim();
        
        // Make sure we have values before we proceed
        if (!latitude || !longitude) {
          return;
        } else {
          myConnector.setLocation(latitude, longitude);
          tableau.submit();
        }
      });
    });         
    
  })();

  </script>
</head>
  <body>
    Latitude:&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="latitude" name="latitude" style="width: 150px;" /> (try 47.6716 for 98103)
    <br />
    Longitude:<input type="text" id="longitude" name="longitude" style="width: 150px;" /> (try -122.3411 for 98103)
    <br />
    <br />
    <button type="button" id="submitButton">Get Weather Forecast</button>
  </body>
</html>
