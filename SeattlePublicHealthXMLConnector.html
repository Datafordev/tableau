<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">

function init() {
  tableau.connectionName = 'Seattle Public Health Inspection Data';
  tableau.initCallback();
}

function shutdown() {
    tableau.shutdownCallback();
}

function getColumnHeaders() {
  console.log('entered getColumnHeaders...');
  _retrieveXmlData(function (tableData) {
    var headers = tableData.headers;
    var fieldNames = [];
    var fieldTypes = [];

    for (var fieldName in headers) {
      if (headers.hasOwnProperty(fieldName)) {
        fieldNames.push(fieldName);
        fieldTypes.push(headers[fieldName]);
      }
    }
    tableau.headersCallback(fieldNames, fieldTypes); // tell tableau about the fields and their types
  });
}
    
function getTableData(lastRecordNumber) {
  console.log('entered getTableData...');
  if (lastRecordNumber) {
    // used for larger data sets. Just return for now.
    tableau.dataCallback([], 0);
    return;
  }

  _retrieveXmlData(function (tableData) {
    var rowData = tableData.rowData;
    tableau.dataCallback(rowData, rowData.length);
  });
}

function _retrieveXmlData(retrieveDataCallback) {
  console.log('entered _retrieveXmlData...');
  if (!window.cachedTableData) {
    var endDate = new Date(),
        zipCode = $('input[type=text]'),
        startDate = new Date();

    zipCode = zipCode[0].value.trim();

    if(!zipCode || zipCode.length < 5) {
      return;
    }

    // set the start of the range to be 1 year ago
    startDate.setYear(endDate.getFullYear() - 1);
    
    // if (lastRecordNumber) {

    //   // used for larger data sets. Just return for now.
    //   tableau.dataCallback([], lastRecordNumber);
    //   return;
    // }
    var connectionUrl = _buildUrl(zipCode, startDate, endDate);


console.log(connectionUrl);



    //var conData = JSON.parse(tableau.connectionData);

    if (connectionUrl) {
      // handle the xml data from the remote source.      
      var xhr = $.ajax({ 
        url: connectionUrl, 
        dataType: 'xml', 
        success: function(data) 
        {
          window.cachedTableData = _xmlToTable(data);
          retrieveDataCallback(window.cachedTableData);
        }
      });
      return;
    }
  }
  retrieveDataCallback(window.cachedTableData);
}

function _runXMLToTableTests() {
  // _findLongestsArray tests

  // _flattenObject tests

  // _extract headers test
}

function _xmlToTable(xmlDocument) {
  var rowData = _flattenData(xmlDocument);
  var headers = _extractHeaders(rowData);
  return {"headers":headers, "rowData":rowData};
}

function _flattenData(xmlDocument) {
  // first find the longest array
  var longestArray = _findLongestArray(xmlDocument, xmlDocument);
  if (!longestArray) {
    // if no array found, just wrap the entire object blob in an array
    longestArray = [objectBlob];
  }
  toRet = [];
  for (var ii = 0; ii < longestArray.childNodes.length; ++ii) {
    toRet[ii] = _flattenObject(longestArray.childNodes[ii]);
  }
  return toRet;
}

function _flattenObject(xmlElt) {
  var toRet = {};
  if (xmlElt.attributes)
  {
    for (var attributeNum = 0; attributeNum < xmlElt.attributes.length; ++attributeNum) {
      var attribute = xmlElt.attributes[attributeNum];
      toRet[attribute.nodeName] = attribute.nodeValue;
    }
  }
  
  var children = xmlElt.childNodes;
  if (!children || !children.length) {
    if (xmlElt.textContent) {
      toRet.text = xmlElt.textContent.trim();
    }
  } else {  
    for (var childNum = 0; childNum < children.length; ++childNum) {
      var child = xmlElt.childNodes[childNum];
      var childName = child.nodeName;

      var subObj = _flattenObject(child);
      for (var k in subObj) {
        if (subObj.hasOwnProperty(k)) {
          toRet[childName + '_' + k] = subObj[k];
        }
      }
    }
  }
  return toRet;
}

function _findLongestArray(xmlElement, bestSoFar) {
  var children = xmlElement.childNodes;
  if (children && children.length) {
    if (children.length > bestSoFar.childNodes.length) {
      bestSoFar = xmlElement;
    }
    for (var childNum in children) {
      var subBest = _findLongestArray(children[childNum], bestSoFar);
      if (subBest.childNodes.length > bestSoFar.childNodes.length) {
        bestSoFar = subBest;
      }
    }
  }
  return bestSoFar;
}

function _extractHeaders(rowData) {
  var toRet = {};
  for (var row = 0; row < rowData.length; ++row) {
    var rowLine = rowData[row];
    for (var key in rowLine) {
      if (rowLine.hasOwnProperty(key)) {
        if (!(key in toRet)) {
          toRet[key] = _determineType(rowLine[key]);
        }
      }
    }
  }
  return toRet;
}

function _determineType(primitive) {
  // possible types: 'float', 'date', 'datetime', 'bool', 'string', 'int'
  if (parseInt(primitive) == primitive) return 'int';
  if (parseFloat(primitive) == primitive) return 'float';
  if (isFinite(new Date(primitive).getTime())) return 'datetime';
  return 'string';
}

function _submitXMLToTableau(xmlUrl) {
    var conData = {"xmlUrl": xmlUrl};
    tableau.connectionData = JSON.stringify(conData);
    console.write(tableau.connectionData);
    tableau.submit();  // this will now call getColumnHeaders
}

// Takes a zip code, a start date and an end date, and constructs a URL for the Seattle Public Health Restaurant Inspection Data API
// http://info.kingcounty.gov/health/ehs/foodsafety/inspections/XmlRest.aspx?Zip_Code=98103&Inspection_Start=4/18/2014&Inspection_End=04/18/2015
function _buildUrl(zipCode, startDate, endDate){
  var startDateStr = _getDateAsString(startDate),
      endDateStr = _getDateAsString(endDate),
      url = 'http://info.kingcounty.gov/health/ehs/foodsafety/inspections/XmlRest.aspx?Zip_Code=' + zipCode + '&Inspection_Start=' + startDateStr + '&Inspection_End=' + endDateStr;
  return url;
}
// Gets a string representation of a date
function _getDateAsString(date){
  return date.getFullYear()  + '-' + _makeTwoDigits(date.getMonth() + 1) + '-' + _makeTwoDigits(date.getDate());
}
// Pads a given number with leading 0s so that there are two characters in the string. Example: _makeTwoDigits(1) --> "01"
function _makeTwoDigits(num) {
  return num < 9 ? "0" + num.toString() : num.toString();
}

$(document).ready(function(){
  $("#inputForm").submit(function(evt) { // This event fires when a button is clicked
    evt.preventDefault();
    var xmlUrl = $('input[name=xmlUrl]')[0].value.trim();
    _submitXMLToTableau(xmlUrl);
  });

  var cancel = function (e) {    
      e.stopPropagation();
      e.preventDefault();
  }

});

</script>

<style>
#dragandrophandler {
  border:1px dashed #999;
  width:300px;
  color:#333;
  text-align:left;vertical-align:middle;
  padding:10px 10px 10 10px;
  margin:10px;
  font-size:150%;
}
</style>
</head>
<body>

<form id="inputForm" action="">
  Enter Zip Code: <input type="text" name="zipCode" style="width: 150px;" />
<!--   <br />
  Enter a URL for XML data: 
  <input type="text" name="xmlUrl" style="width: 400px;" />  
  <br>
  <div id="dragandrophandler">Or Drag & Drop Files Here</div>
  <br>
  Or paste XML data below
  <br>
  <textarea name="xmlText" rows="10" cols="70"/>
  </textarea> -->
  <input type="submit" value="Submit">
</form>

</body>
</html>